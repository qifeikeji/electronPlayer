# å¥å£®ç‰ˆGitHub Action - å¤„ç†ä¾èµ–åŒæ­¥é—®é¢˜
# æ–‡ä»¶è·¯å¾„: .github/workflows/build-linux-robust.yml

name: Build Linux AppImage (Robust)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        # æš‚æ—¶ä¸ä½¿ç”¨npmç¼“å­˜ï¼Œå› ä¸ºä¾èµ–ç‰ˆæœ¬ä¸åŒæ­¥
        # cache: 'npm'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libnss3-dev \
          libatk-bridge2.0-dev \
          libdrm2 \
          libxkbcommon-dev \
          libxss1 \
          libasound2-dev \
          libgtk-3-dev \
          libxrandr2 \
          libasound2-dev \
          libpangocairo-1.0-0 \
          libatk1.0-0 \
          libcairo-gobject2 \
          libgtk-3-0 \
          libgdk-pixbuf2.0-0
        
    - name: Clean and install dependencies
      run: |
        echo "ğŸ§¹ Cleaning existing node_modules and lock files..."
        rm -rf node_modules
        rm -f package-lock.json
        rm -f yarn.lock
        
        echo "ğŸ“¦ Installing dependencies from scratch..."
        npm install
        
        echo "ğŸ” Checking if electron-builder is available..."
        if ! npm list electron-builder &>/dev/null; then
          echo "âš ï¸ electron-builder not found, installing globally..."
          npm install -g electron-builder
        fi
        
        echo "âœ… Dependency installation complete"
        
    - name: Verify project structure
      run: |
        echo "ğŸ“ Project structure:"
        ls -la
        echo "ğŸ“„ Package.json scripts:"
        cat package.json | jq '.scripts' || echo "No jq available, showing raw package.json"
        echo "ğŸ” Looking for main entry point..."
        cat package.json | grep -E '"main":|"electron":|"build":' || echo "No main/electron/build config found"
        
    - name: Build React/Vite application
      run: |
        echo "ğŸ”¨ Building frontend application..."
        if npm run build; then
          echo "âœ… Frontend build successful"
        elif npm run dev:build; then
          echo "âœ… Frontend build successful (dev:build)"
        else
          echo "âš ï¸ No standard build script found, trying manual Vite build..."
          npx vite build || echo "âŒ Vite build failed"
        fi
      env:
        CI: false
        NODE_ENV: production
        
    - name: Build Electron application
      run: |
        echo "âš¡ Building Electron application for Linux..."
        
        # æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
        echo "ğŸ“ Setting up build directories..."
        mkdir -p dist-electron
        mkdir -p dist
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ Electron ä¸»è¿›ç¨‹æ–‡ä»¶
        if [ -f "electron/main.js" ]; then
          echo "ğŸ“‹ Found main.js in electron/ directory"
          cp electron/main.js dist-electron/main.js
        elif [ -f "src/main.js" ]; then
          echo "ğŸ“‹ Found main.js in src/ directory"  
          cp src/main.js dist-electron/main.js
        elif [ -f "main.js" ]; then
          echo "ğŸ“‹ Found main.js in root directory"
          cp main.js dist-electron/main.js
        else
          echo "âš ï¸ No main.js found, creating a basic one..."
          cat > dist-electron/main.js << 'EOF'
const { app, BrowserWindow } = require('electron');
const path = require('path');

const createWindow = () => {
  const mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: true,
      contextIsolation: false
    }
  });

  if (process.env.NODE_ENV === 'development') {
    mainWindow.loadURL('http://localhost:3000');
  } else {
    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'));
  }
};

app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

app.on('activate', () => {
  if (BrowserWindow.getAllWindows().length === 0) {
    createWindow();
  }
});
EOF
        fi
        
        # å°è¯•å¤šç§æ„å»ºæ–¹å¼
        if npm run electron:build; then
          echo "âœ… Built with npm run electron:build"
        elif npm run build:linux; then
          echo "âœ… Built with npm run build:linux"
        elif npm run dist; then
          echo "âœ… Built with npm run dist"
        else
          echo "ğŸ”§ Trying direct electron-builder command..."
          
          # ç¡®ä¿æœ‰åŸºæœ¬çš„ dist å†…å®¹
          if [ ! -f "dist/index.html" ]; then
            echo "âš ï¸ Creating basic dist/index.html..."
            cat > dist/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ElectronPlayer</title>
</head>
<body>
    <div id="root">
        <h1>ElectronPlayer</h1>
        <p>Media Player Built with Electron</p>
    </div>
</body>
</html>
EOF
          fi
          
          # ç›´æ¥ä½¿ç”¨electron-builder
          if command -v electron-builder &> /dev/null; then
            electron-builder --linux appimage --publish never
          else
            npx electron-builder --linux appimage --publish never
          fi
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI: true
        
    - name: List all possible build outputs
      run: |
        echo "ğŸ” Searching for build outputs in entire project..."
        echo "=== AppImage files ==="
        find . -name "*.AppImage" -type f -exec ls -lh {} \; 2>/dev/null || echo "No AppImage files found"
        
        echo "=== DEB files ==="
        find . -name "*.deb" -type f -exec ls -lh {} \; 2>/dev/null || echo "No DEB files found"
        
        echo "=== Common build directories ==="
        for dir in dist build out release app-builds; do
          if [ -d "$dir" ]; then
            echo "Contents of $dir/:"
            ls -la "$dir/"
          fi
        done
        
        echo "=== Electron-builder output directory ==="
        if [ -d "dist" ]; then
          find dist -type f -name "*linux*" -o -name "*.AppImage" -o -name "*.deb" 2>/dev/null || echo "No Linux builds in dist/"
        fi
        
    - name: Find AppImage file
      id: find_appimage
      run: |
        echo "ğŸ” Looking for AppImage file..."
        
        # æœç´¢AppImageæ–‡ä»¶ï¼Œæ’é™¤node_modules
        APPIMAGE_PATH=$(find . \( -path "./node_modules" -prune \) -o \( -name "*.AppImage" -type f -print \) | head -1)
        
        if [ -n "$APPIMAGE_PATH" ] && [ -f "$APPIMAGE_PATH" ]; then
          echo "âœ… Found AppImage: $APPIMAGE_PATH"
          echo "appimage_path=$APPIMAGE_PATH" >> $GITHUB_OUTPUT
          echo "appimage_name=$(basename $APPIMAGE_PATH)" >> $GITHUB_OUTPUT
          echo "appimage_size=$(du -h $APPIMAGE_PATH | cut -f1)" >> $GITHUB_OUTPUT
          
          # éªŒè¯æ–‡ä»¶
          echo "ğŸ“Š File info:"
          ls -lh "$APPIMAGE_PATH"
          file "$APPIMAGE_PATH"
          
          # æ£€æŸ¥æ˜¯å¦å¯æ‰§è¡Œ
          if [ -x "$APPIMAGE_PATH" ]; then
            echo "âœ… AppImage is executable"
          else
            echo "âš ï¸ Making AppImage executable..."
            chmod +x "$APPIMAGE_PATH"
          fi
          
        else
          echo "âŒ No AppImage found!"
          echo "ğŸ” All files in project:"
          find . -type f -name "*electron*" -o -name "*app*" -o -name "*.deb" -o -name "*.tar.gz" | head -20
          
          # å°è¯•æ‰‹åŠ¨æ„å»º
          echo "ğŸ”§ Attempting manual AppImage creation..."
          if command -v electron-builder &> /dev/null; then
            echo "Trying one more electron-builder attempt..."
            electron-builder --linux appimage --config.directories.output=manual-dist
            
            # å†æ¬¡æŸ¥æ‰¾
            MANUAL_APPIMAGE=$(find . -name "*.AppImage" -type f | head -1)
            if [ -n "$MANUAL_APPIMAGE" ]; then
              echo "âœ… Manual build successful: $MANUAL_APPIMAGE"
              echo "appimage_path=$MANUAL_APPIMAGE" >> $GITHUB_OUTPUT
              echo "appimage_name=$(basename $MANUAL_APPIMAGE)" >> $GITHUB_OUTPUT
              echo "appimage_size=$(du -h $MANUAL_APPIMAGE | cut -f1)" >> $GITHUB_OUTPUT
            else
              exit 1
            fi
          else
            exit 1
          fi
        fi
        
    - name: Upload AppImage to Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ElectronPlayer-Linux-AppImage-${{ github.run_number }}
        path: ${{ steps.find_appimage.outputs.appimage_path }}
        retention-days: 30
        compression-level: 0
        
    - name: Upload build logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          package.json
          package-lock.json
          npm-debug.log*
          *.log
        retention-days: 7
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/') && success()
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ steps.find_appimage.outputs.appimage_path }}
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸ‰ ElectronPlayer Linux AppImage
          
          ğŸ“¦ **File**: `${{ steps.find_appimage.outputs.appimage_name }}`
          ğŸ“ **Size**: ${{ steps.find_appimage.outputs.appimage_size }}
          ğŸ”¨ **Built from**: `${{ github.sha }}`
          
          ### ğŸš€ Quick Start
          ```bash
          # Download and run
          chmod +x ${{ steps.find_appimage.outputs.appimage_name }}
          ./${{ steps.find_appimage.outputs.appimage_name }}
          ```
          
          ### âœ¨ Features
          - ğŸµ Multiple video and audio format support
          - ğŸ® Keyboard shortcuts and intuitive controls  
          - ğŸ–¼ï¸ Screenshot capture functionality
          - ğŸ“‚ Playlist management
          - ğŸ–¥ï¸ Full-screen mode
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
